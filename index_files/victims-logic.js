RegExp.escape=function(s){return s.replace(/[-\/\\^$*+?.()|[\]{}]/g,'\\$&');};(function($){'use strict';$.csv={defaults:{separator:',',delimiter:'"',headers:true},hooks:{castToScalar:function(value,state){var hasDot=/\./;if(isNaN(value))return value;else if(hasDot.test(value))return parseFloat(value);else{var integer=parseInt(value);if(isNaN(integer))return null;else return integer;}}},parsers:{parse:function(csv,options){var separator=options.separator;var delimiter=options.delimiter;if(!options.state.rowNum)options.state.rowNum=1;if(!options.state.colNum)options.state.colNum=1;var data=[];var entry=[];var state=0;var value='';var exit=false;function endOfEntry(){state=0;value='';if(options.start&&options.state.rowNum<options.start){entry=[];options.state.rowNum++;options.state.colNum=1;return;}if(options.onParseEntry===undefined)data.push(entry);else{var hookVal=options.onParseEntry(entry,options.state);if(hookVal!==false)data.push(hookVal);}entry=[];if(options.end&&options.state.rowNum>=options.end)exit=true;options.state.rowNum++;options.state.colNum=1;}function endOfValue(){if(options.onParseValue===undefined)entry.push(value);else{var hook=options.onParseValue(value,options.state);if(hook!==false)entry.push(hook);}value='';state=0;options.state.colNum++;}var escSeparator=RegExp.escape(separator);var escDelimiter=RegExp.escape(delimiter);var match=/(D|S|\n|\r|[^DS\r\n]+)/;var matchSrc=match.source;matchSrc=matchSrc.replace(/S/g,escSeparator);matchSrc=matchSrc.replace(/D/g,escDelimiter);match=RegExp(matchSrc,'gm');csv.replace(match,function(m0){if(exit)return;switch(state){case 0:if(m0===separator){value+='';endOfValue();break;}if(m0===delimiter){state=1;break;}if(m0==='\n'){endOfValue();endOfEntry();break;}if(/^\r$/.test(m0))break;value+=m0;state=3;break;case 1:if(m0===delimiter){state=2;break;}value+=m0;state=1;break;case 2:if(m0===delimiter){value+=m0;state=1;break;}if(m0===separator){endOfValue();break;}if(m0==='\n'){endOfValue();endOfEntry();break;}if(/^\r$/.test(m0))break;throw new Error('CSVDataError: Illegal State [Row:'+options.state.rowNum+'][Col:'+options.state.colNum+']');case 3:if(m0===separator){endOfValue();break;}if(m0==='\n'){endOfValue();endOfEntry();break;}if(/^\r$/.test(m0))break;if(m0===delimiter)throw new Error('CSVDataError: Illegal Quote [Row:'+options.state.rowNum+'][Col:'+options.state.colNum+']');throw new Error('CSVDataError: Illegal Data [Row:'+options.state.rowNum+'][Col:'+options.state.colNum+']');default:throw new Error('CSVDataError: Unknown State [Row:'+options.state.rowNum+'][Col:'+options.state.colNum+']');}});if(entry.length!==0){endOfValue();endOfEntry();}return data;},splitLines:function(csv,options){var separator=options.separator;var delimiter=options.delimiter;if(!options.state.rowNum)options.state.rowNum=1;var entries=[];var state=0;var entry='';var exit=false;function endOfLine(){state=0;if(options.start&&options.state.rowNum<options.start){entry='';options.state.rowNum++;return;}if(options.onParseEntry===undefined)entries.push(entry);else{var hookVal=options.onParseEntry(entry,options.state);if(hookVal!==false)entries.push(hookVal);}entry='';if(options.end&&options.state.rowNum>=options.end)exit=true;options.state.rowNum++;}var escSeparator=RegExp.escape(separator);var escDelimiter=RegExp.escape(delimiter);var match=/(D|S|\n|\r|[^DS\r\n]+)/;var matchSrc=match.source;matchSrc=matchSrc.replace(/S/g,escSeparator);matchSrc=matchSrc.replace(/D/g,escDelimiter);match=RegExp(matchSrc,'gm');csv.replace(match,function(m0){if(exit)return;switch(state){case 0:if(m0===separator){entry+=m0;state=0;break;}if(m0===delimiter){entry+=m0;state=1;break;}if(m0==='\n'){endOfLine();break;}if(/^\r$/.test(m0))break;entry+=m0;state=3;break;case 1:if(m0===delimiter){entry+=m0;state=2;break;}entry+=m0;state=1;break;case 2:var prevChar=entry.substr(entry.length-1);if(m0===delimiter&&prevChar===delimiter){entry+=m0;state=1;break;}if(m0===separator){entry+=m0;state=0;break;}if(m0==='\n'){endOfLine();break;}if(m0==='\r')break;throw new Error('CSVDataError: Illegal state [Row:'+options.state.rowNum+']');case 3:if(m0===separator){entry+=m0;state=0;break;}if(m0==='\n'){endOfLine();break;}if(m0==='\r')break;if(m0===delimiter)throw new Error('CSVDataError: Illegal quote [Row:'+options.state.rowNum+']');throw new Error('CSVDataError: Illegal state [Row:'+options.state.rowNum+']');default:throw new Error('CSVDataError: Unknown state [Row:'+options.state.rowNum+']');}});if(entry!=='')endOfLine();return entries;},parseEntry:function(csv,options){var separator=options.separator;var delimiter=options.delimiter;if(!options.state.rowNum)options.state.rowNum=1;if(!options.state.colNum)options.state.colNum=1;var entry=[];var state=0;var value='';function endOfValue(){if(options.onParseValue===undefined)entry.push(value);else{var hook=options.onParseValue(value,options.state);if(hook!==false)entry.push(hook);}value='';state=0;options.state.colNum++;}if(!options.match){var escSeparator=RegExp.escape(separator);var escDelimiter=RegExp.escape(delimiter);var match=/(D|S|\n|\r|[^DS\r\n]+)/;var matchSrc=match.source;matchSrc=matchSrc.replace(/S/g,escSeparator);matchSrc=matchSrc.replace(/D/g,escDelimiter);options.match=RegExp(matchSrc,'gm');}csv.replace(options.match,function(m0){switch(state){case 0:if(m0===separator){value+='';endOfValue();break;}if(m0===delimiter){state=1;break;}if(m0==='\n'||m0==='\r')break;value+=m0;state=3;break;case 1:if(m0===delimiter){state=2;break;}value+=m0;state=1;break;case 2:if(m0===delimiter){value+=m0;state=1;break;}if(m0===separator){endOfValue();break;}if(m0==='\n'||m0==='\r')break;throw new Error('CSVDataError: Illegal State [Row:'+options.state.rowNum+'][Col:'+options.state.colNum+']');case 3:if(m0===separator){endOfValue();break;}if(m0==='\n'||m0==='\r')break;if(m0===delimiter)throw new Error('CSVDataError: Illegal Quote [Row:'+options.state.rowNum+'][Col:'+options.state.colNum+']');throw new Error('CSVDataError: Illegal Data [Row:'+options.state.rowNum+'][Col:'+options.state.colNum+']');default:throw new Error('CSVDataError: Unknown State [Row:'+options.state.rowNum+'][Col:'+options.state.colNum+']');}});endOfValue();return entry;}},toArray:function(csv,options,callback){var options=(options!==undefined?options:{});var config={};config.callback=((callback!==undefined&&typeof callback==='function')?callback:false);config.separator='separator' in options?options.separator:$.csv.defaults.separator;config.delimiter='delimiter' in options?options.delimiter:$.csv.defaults.delimiter;var state=(options.state!==undefined?options.state:{});var options={delimiter:config.delimiter,separator:config.separator,onParseEntry:options.onParseEntry,onParseValue:options.onParseValue,state:state};var entry=$.csv.parsers.parseEntry(csv,options);if(!config.callback)return entry;else config.callback('',entry);},toArrays:function(csv,options,callback){var options=(options!==undefined?options:{});var config={};config.callback=((callback!==undefined&&typeof callback==='function')?callback:false);config.separator='separator' in options?options.separator:$.csv.defaults.separator;config.delimiter='delimiter' in options?options.delimiter:$.csv.defaults.delimiter;var data=[];var options={delimiter:config.delimiter,separator:config.separator,onParseEntry:options.onParseEntry,onParseValue:options.onParseValue,start:options.start,end:options.end,state:{rowNum:1,colNum:1}};data=$.csv.parsers.parse(csv,options);if(!config.callback)return data;else config.callback('',data);},toObjects:function(csv,options,callback){var options=(options!==undefined?options:{});var config={};config.callback=((callback!==undefined&&typeof callback==='function')?callback:false);config.separator='separator' in options?options.separator:$.csv.defaults.separator;config.delimiter='delimiter' in options?options.delimiter:$.csv.defaults.delimiter;config.headers='headers' in options?options.headers:$.csv.defaults.headers;options.start='start' in options?options.start:1;if(config.headers)options.start++;if(options.end&&config.headers)options.end++;var lines=[];var data=[];var options={delimiter:config.delimiter,separator:config.separator,onParseEntry:options.onParseEntry,onParseValue:options.onParseValue,start:options.start,end:options.end,state:{rowNum:1,colNum:1},match:false};var headerOptions={delimiter:config.delimiter,separator:config.separator,start:1,end:1,state:{rowNum:1,colNum:1}};var headerLine=$.csv.parsers.splitLines(csv,headerOptions);var headers=$.csv.toArray(headerLine[0],options);var lines=$.csv.parsers.splitLines(csv,options);options.state.colNum=1;if(headers)options.state.rowNum=2;else options.state.rowNum=1;for(var i=0,len=lines.length;i<len;i++){var entry=$.csv.toArray(lines[i],options);var object={};for(var j in headers)object[headers[j]]=entry[j];data.push(object);options.state.rowNum++;}if(!config.callback)return data;else config.callback('',data);},fromArrays:function(arrays,options,callback){var options=(options!==undefined?options:{});var config={};config.callback=((callback!==undefined&&typeof callback==='function')?callback:false);config.separator='separator' in options?options.separator:$.csv.defaults.separator;config.delimiter='delimiter' in options?options.delimiter:$.csv.defaults.delimiter;config.escaper='escaper' in options?options.escaper:$.csv.defaults.escaper;config.experimental='experimental' in options?options.experimental:false;if(!config.experimental)throw new Error('not implemented');var output=[];for(i in arrays)output.push(arrays[i]);if(!config.callback)return output;else config.callback('',output);},fromObjects2CSV:function(objects,options,callback){var options=(options!==undefined?options:{});var config={};config.callback=((callback!==undefined&&typeof callback==='function')?callback:false);config.separator='separator' in options?options.separator:$.csv.defaults.separator;config.delimiter='delimiter' in options?options.delimiter:$.csv.defaults.delimiter;config.experimental='experimental' in options?options.experimental:false;if(!config.experimental)throw new Error('not implemented');var output=[];for(i in objects)output.push(arrays[i]);if(!config.callback)return output;else config.callback('',output);}};$.csvEntry2Array=$.csv.toArray;$.csv2Array=$.csv.toArrays;$.csv2Dictionary=$.csv.toObjects;})(jQuery);
function Filter(value){var items=null;var subset=null;if(!arguments.length){items=[];subset=[];rest=[];}else{items=value;subset=value;rest=[];}function my(){}my.items=function(value){if(!arguments.length)return items;items=value;subset=items;rest=[];return my;};my.reset=function(value){if(!arguments.length){subset=items;rest=[];return my;}items=value;subset=items;rest=[];return my;};my.sort=function(value){if(!arguments.length)return items;items=_.sortBy(items,value);subset=items;return my;};my.filter=function(value){if(!arguments.length)return subset;subset=_.filter(subset,value);rest=_.reject(items,function(v){return _.contains(subset,v);});return my;};my.go=function(){return subset;};my.rest=function(){return rest;};return my;}
$(document).ready(function(){var VICTIM_CSV='http://www.startribune.com/includes/victims.csv';var ANIMATION_MILISECONDS=1000;var ITEMS_ID_PREFIX_STR='#item-';var VICTIMS_CLASS='.smallThumb';var MAP_ZOOM=10;var MAP_OPTIONS={scrollWheelZoom:false,touchZoom:false};var BASE_LAYER_URL='http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png';var BASE_LAYER_OPTIONS={opacity:1.0,subdomains:['a','b','c']};var MARKER_ICON=L.icon({iconUrl:'http://stmedia.startribune.com/designimages/leaflet-0.5-marker-icon.png',iconRetinaUrl:'http://stmedia.startribune.com/designimages/leaflet-0.5-marker-icon-2x.png',shadowUrl:'http://stmedia.startribune.com/designimages/leaflet-0.5-marker-shadow.png',iconSize:[25,41],iconAnchor:[12,41]});var victim_template_el=$('#victim-template');var victim_template_target_el=$('#victim-target');var sort_in_metro_el=$('#sort-in-metro');var sort_out_metro_el=$('#sort-out-metro');var sort_age_desc_el=$('#sort-age-desc');var sort_age_asc_el=$('#sort-age-asc');var sort_date_desc_el=$('#sort-date-desc');var sort_date_asc_el=$('#sort-date-asc');var details_row_els=$('.details-row');var details_name_el=$('#details-name');var details_dob_el=$('#details-dob');var details_dod_el=$('#details-dod');var details_age_el=$('#details-age');var details_about_el=$('#details-about');var details_article_el=$('#details-article');var details_photo_el=$('#details-photo');var details_location_el=$('#details-location');var map_el_str='map';var positions=[];var victim_template=_.template(victim_template_el.html());var items=null;var filter=null;var map=new L.Map(map_el_str,MAP_OPTIONS);var baseLayer=new L.TileLayer(BASE_LAYER_URL,BASE_LAYER_OPTIONS);map.addLayer(baseLayer);var marker=null;var victim_data=null;var initVictims=function(){victim_template_target_el.html(victim_template({'items':items}));_.each(items,function(e,i){var el=$(ITEMS_ID_PREFIX_STR+i);var position=$(el).position();el.css(position);positions.push(position);el.click(handleVictimClick);});$(VICTIMS_CLASS).css('position','absolute');};var fillOrShow=function(victim,item,el){if(victim[item.toString()])el.html(victim[item.toString()]);else el.parent().hide();};var handleVictimClick=function(e){var id=e.target.id;var id_num=id.substring(ITEMS_ID_PREFIX_STR.length-1,id.length);var victim=items[id_num];$('.victim-activated').removeClass('victim-activated');$('#'+id).addClass('victim-activated');details_row_els.show();details_name_el.html(victim.Name);fillOrShow(victim,'BirthDate',details_dob_el);fillOrShow(victim,'DeathDate',details_dod_el);fillOrShow(victim,'AgeYears',details_age_el);fillOrShow(victim,'About',details_about_el);if(victim.URL&&victim.Headline)details_article_el.html(["<a target=_\"blank\" href=\"",victim.URL,"\">",victim.Headline,"</a>"].join(""));else details_article_el.parent().hide();var photo_url=victim.Photo_URL||"http://stmedia.startribune.com/images/gunVics_noPhoto.png";details_photo_el.html('<img class="bigPhoto" src="'+photo_url+'">');details_location_el.html([victim.Injury_Address,victim.Injury_City].join('<br />'));if(victim.Lat!=0&&victim.Lon!=0){var latlng=[victim.Lat,victim.Lon];if(marker)marker.setLatLng(latlng);else marker=new L.marker(latlng,{icon:MARKER_ICON});map.addLayer(marker);map.setView(latlng,MAP_ZOOM);}else{map.removeLayer(marker);map.setView([44.98,-93.27],MAP_ZOOM);}};var toggleActiveClass=function(_el){var el=$(_el);if(el.hasClass('facet-active'))el.removeClass('facet-active');else el.addClass('facet-active');};var handleStateChange=function(){filter.reset();var active_sort=$('#sort-group-age').children('.facet-active').attr('id');filter.sort(facet_map[active_sort]);var active_filters=$('#sort-group-metro').children('.facet-active');_.each(active_filters,function(v,i){var facet_id=$(v).attr('id');filter.filter(facet_map[facet_id]);});var subset=filter.go();var rest=filter.rest();reposition(subset,rest);};var reposition=function(_subset,_rest){var _positions=positions.slice();$('.victim-active').removeClass('victim-active');$('.victim-inactive').removeClass('victim-inactive');_.each(_subset,function(e,i){var el=$(ITEMS_ID_PREFIX_STR+(e.id-1));el.addClass('victim-active');if(i==0)el.click();});_.each(_rest,function(e,i){var el=$(ITEMS_ID_PREFIX_STR+(e.id-1));el.addClass('victim-inactive');});var _items=_subset.concat(_rest);_.each(_items,function(e,i){var el=$(ITEMS_ID_PREFIX_STR+(e.id-1));var position=_positions.shift();$(el).stop().animate({'top':position.top},ANIMATION_MILISECONDS,function(){$(el).animate({'left':position.left},ANIMATION_MILISECONDS);});});};var getVictimData=function(){$.get(VICTIM_CSV,function(data){victim_data=$.csv.toObjects(data);items=victim_data;filter=Filter(items);initVictims();initFacets();$('#sort-age-asc').click();});};var initFacets=function(){$('#sort-group-metro > .sort-item').click(function(e){var el=$(this);var id=el.parent().attr('id');if(el.hasClass('facet-active'))el.removeClass('facet-active');else{$('#'+id).children('.facet-active').removeClass('facet-active');el.addClass('facet-active');}handleStateChange();});$('#sort-group-age > .sort-item').click(function(){var id=$(this).parent().attr('id');$('#'+id).children('.facet-active').removeClass('facet-active');$(this).addClass('facet-active');handleStateChange();});};getVictimData();var isValidDate=function(d){if(Object.prototype.toString.call(d)!=='[object Date]')return false;return !isNaN(d.getTime());};var sort_age_asc=function(v){return v.AgeDays;};var sort_age_desc=function(v){return -v.AgeDays;};var sort_in_metro=function(v){if(v.Metro=='Y')return true;return false;};var sort_out_metro=function(v){return !sort_in_metro(v);};var sort_date_asc=function(v){var date=new Date(v.DeathDate);if(isValidDate(date)){comp_date=new Date(0);return date-comp_date;}return null;};var sort_date_desc=function(v){var date=new Date(v.DeathDate);if(isValidDate(date)){comp_date=new Date(0);return comp_date-date;}return null;};var facet_map={'sort-in-metro':sort_in_metro,'sort-out-metro':sort_out_metro,'sort-age-asc':sort_age_asc,'sort-age-desc':sort_age_desc,'sort-date-asc':sort_date_asc,'sort-date-desc':sort_date_desc};});